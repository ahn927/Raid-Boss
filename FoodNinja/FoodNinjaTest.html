<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Worst Game Ever Made</title>
    <!--<script src="js/gyro.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-touch-events/1.0.5/jquery.mobile-events.js"></script> -->
   <!-- <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script> -->
   <script src="//cdn.jsdelivr.net/npm/phaser-ce@2.10.3/build/phaser.js"></script>
    <script src="gyronorm/dist/gyronorm.complete.min.js"></script>
    <!--<script src="gyronorm/dist/fulltilt.min.js"></script> -->
    <script src="gyronorm/dist/gyronorm.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
        canvas{
          
        }
        .hidden{
            display: inline-block !important;
        }
    </style>
</head>

<body>
    <div id = "whole">
    <!--<p class = "text">Hello world</p> -->
    <script type="text/javascript">
        $(document).ready(function () {
            
           
            var game;

           /* $("#" + game).addClass(".hidden");
            $("canvas").addClass(".hidden");
            //$(".text").show();

            $("#whole").click(function(){
                console.log("clicked");
                $("canvas").removeClass(".hidden");
                $(".text").hide();
            }); */
 

            var gn = new GyroNorm();
            

            //function that returns true if the device is mobile device
            function isMobile() { 
                return ('ontouchstart' in document.documentElement);
            }
            var mobileDevice = false;

            //calls the isMobile function and sets mobileDevice to true if it is mobile device. 
            if (isMobile()){
                console.log("in mobile!")
                mobileDevice = true;
            }

        //  $.browser.device = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
            //if ($.browser)
            game = new Phaser.Game(1000, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
            
            /*game.state.add("Menu", game.boot);
            game.state.start("Menu");
            
            game.MainMenu = function(){};
 
            game.MainMenu.pro = {
            create: function() {
                console.log("hi");},
                update: function() {
                    console.log("bai");
                    game.preload;
                }
            }; */


            function preload() {

                game.load.image('sky', 'assets/sky.png');
                game.load.image('ground', 'assets/platform.png');
                game.load.image('star', 'assets/star.png');
                game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
                game.load.spritesheet('foods', 'assets/foodtest.png', 68.375, 68.57142857);

            }

            var player;
            var platforms;
            var cursors;


            var foods;
            var food;
            food = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
            var index = 0;
            var score = 0;
            var scoreText;
            var hitPlatform;
            var jump=0;
            var count = 0;

            function create() {

                //  Enables physics system
                game.physics.startSystem(Phaser.Physics.ARCADE);

                //  Creates the background for the game.
                var sky = game.add.sprite(0, 0, 'sky');

                platforms = game.add.group();
                //  Enables physics for any object that is created in this group
                platforms.enableBody = true;

                //Create the ground.
                var ground = platforms.create(0, game.world.height - 64, 'ground');

                //  Scale ground and sky to fit the screen of the game.
                ground.scale.setTo(3, 2);
                sky.scale.setTo(2,1);

                //  This stops the ground from moving when it collides 
                ground.body.immovable = true;

            /* //  Now let's create two ledges
                var ledge = platforms.create(400, 400, 'ground');
                ledge.body.immovable = true;

                ledge = platforms.create(-150, 250, 'ground');
                ledge.body.immovable = true; */

                // The player and its settings
                player = game.add.sprite(32, game.world.height - 150, 'dude');

                //  We need to enable physics on the player
                game.physics.arcade.enable(player);

                //  Player physics properties. Give the little guy a slight bounce.
                player.body.bounce.y = 0.2;
                player.body.gravity.y = 700;
                player.body.collideWorldBounds = true;

                //  Our two animations, walking left and right.
                player.animations.add('left', [0, 1, 2, 3], 10, true);
                player.animations.add('right', [5, 6, 7, 8], 10, true);

                //  Adds the foods
            // foods = game.add.group();

                //  Enables physics for foods 
                //foods.enableBody = true;
                
                //spawnFood();
                
                game.input.onTap.add(onTap, this);

              
                game.time.events.repeat(Phaser.Timer.SECOND * 1, 50, spawnFood, this);
                
                //Creates score text
                scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

                //Initiazes controls.
                cursors = game.input.keyboard.createCursorKeys();
                

            }

            function update() {
                if (game.pause == true){
                    return;
                }
                gn.init().then(function(){
                gn.start(function(data){
                    // Process:
                    // data.do.alpha	( deviceorientation event alpha value )
                    // data.do.beta		( deviceorientation event beta value )
                    // data.do.gamma	( deviceorientation event gamma value )
                    // data.do.absolute	( deviceorientation event absolute value )

                    // data.dm.x		( devicemotion event acceleration x value )
                    // data.dm.y		( devicemotion event acceleration y value )
                    // data.dm.z		( devicemotion event acceleration z value )

                    // data.dm.gx		( devicemotion event accelerationIncludingGravity x value )
                    // data.dm.gy		( devicemotion event accelerationIncludingGravity y value )
                    // data.dm.gz		( devicemotion event accelerationIncludingGravity z value )

                    // data.dm.alpha	( devicemotion event rotationRate alpha value )
                    // data.dm.beta		( devicemotion event rotationRate beta value )
                    // data.dm.gamma	( devicemotion event rotationRate gamma value )
                    //alert(data.dm.alpha + ", " + data.dm.beta + ", " + data.dm.gamma);
                    if (data.dm.gx < -0.5){
                        player.body.velocity.x = -500;
                        //player.body.acceleration.x= -200;
                        player.animations.play('left');
                    }
                    else if (data.dm.gx > 0.5){
                        player.body.velocity.x = 500;
                        //player.body.acceleration.x= 200;
                        player.animations.play('right');
                    }
                    else if (isMobile) {
                        player.animations.stop();
                        //player.frame = 4;
                    }

                    /*scoreText.text = 'Score: ' + data.dm.alpha + ", " + data.dm.beta + ", " + data.dm.gamma 
                    +" || " + data.do.alpha + ", " + data.do.beta + ", "  + data.do.gamma 
                    +" || " + data.dm.x + ", " + data.dm.y + ", "  + data.dm.z
                    +" || " + data.dm.gx + ", " + data.dm.gy + ", "  + data.dm.gz; */


                });
                    
                }).catch(function(e){
                // Catch if the DeviceOrientation or DeviceMotion is not supported by the browser or device
                    alert("failed gyro");
                }); 

                //  Collide the player and the foods with the platforms
                hitPlatform = game.physics.arcade.collide(player, platforms);

                //Checks if the food hits the ground, if so, removes the food.
                var foodHitPlatform; 
                var position;
                for (var i = 0; i< food.length; i++){
                    footHitPlatform = game.physics.arcade.collide(food[i], platforms);
                    if (footHitPlatform){
                            food[i].kill();
                            count++;
                    }
                }

                //  Checks to see if the player overlaps with any of the foods, if it does, collect fruit
                game.physics.arcade.overlap(player, food, collectFood, null, this);
                
                //  Reset the players velocity (movement)
                player.body.velocity.x = 0;
                
                //mobile tap jump
                if (cursors.up.isDown) {
                    if (player.body.touching.down && hitPlatform){
                            if (player.body.velocity.y < 0 ){
                                player.body.velocity.y = -600;
                                console.log ("touch jump");
                                jump = 1;
                            }
                    }
                    else if (!player.body.touching.down && !hitPlatform){
                        if (player.body.velocity.y > 0 && jump == 1){
                            player.body.velocity.y = -350;
                            console.log("touch double jump");
                            jump = 0;
                        }
                    }
                } 

                //failed attempt at multi touch
              /*  if (game.input.pointer1.up.isDown &&game.input.pointer2.up.isDown ) {

                    if (!player.body.touching.down && !hitPlatform){
                      
                            player.body.velocity.y = 2000;
                            console.log("fast fall");
                        
                    }
                } */
                
                if (mobileDevice == true){
                }

                if (cursors.left.isDown) {
                    //  Move to the left
                    player.body.velocity.x = -300;
                    player.body.acceleration.x= 4;

                    player.animations.play('left');
                }
                else if (cursors.right.isDown) {
                    //  Move to the right
                    player.body.velocity.x = 300;

                    player.animations.play('right');
                }
                else if (!isMobile) {
                    //  Stand still
                    player.animations.stop();
                    
                    player.frame = 4;
                }

                //  Allow the player to jump if they are touching the ground.
                if (cursors.up.isDown) {
                    if (player.body.touching.down && hitPlatform){
                            if (player.body.velocity.y < 0 ){
                                player.body.velocity.y = -600;
                                jump = 1;
                            }
                     }
                    else if (!player.body.touching.down && !hitPlatform){
                        if (player.body.velocity.y > 0 && jump == 1){
                            player.body.velocity.y = -350;
                            jump = 0;
                        }
                    }
                }

                if (cursors.down.isDown && !player.body.touching.down && !hitPlatform){
                    player.body.velocity.y = 2000;
                }
                
                if (count == 50){
                    game.pause = true;
                    finalScore = game.add.text(300, 300, 'Your score is: ' + score, { fontSize: '32px', fill: '#000' });

                }
                
                
            

            }

            function collectFood(player, food) {

                food.kill();


                score += 1;
                count++;
                scoreText.text = 'Score: ' + score;

            }

            function spawnFood(){
                
                var min = 0;
                var max = 900;
                var randomX;
                var randomIndex;

            
                //  Create a star inside of the 'foods' group
                //var food = foods.create(i * 70, 0, 'foods');
                randomX = Math.random() * max + min;
                randomIndex = Math.round(Math.random() * 48);
                food[index] = game.add.sprite(randomX, 0, 'foods', randomIndex);

                game.physics.arcade.enable(food);
                
                console.log("inside loop");
                //game.physics.arcade.gravity.y = 200;

                //  Let gravity do its thing
                food[index].body.gravity.y = 200;
                
                //  Lets the food bounce, for easy mode LOL
                food[index].body.bounce.y = 0.7 + Math.random() * 0.2;

                index++;
                if (index == 20){
                index = 0;
                }         

            }
            
            function onTap(pointer, doubleTap) {  
                if (!doubleTap){
                    console.log("single tap");
                        if (player.body.touching.down && hitPlatform){
                            if (player.body.velocity.y < 0 ){
                                player.body.velocity.y = -600;
                                jump = 1;
                            }
                        }
                        else if (!player.body.touching.down && !hitPlatform){
                            if (player.body.velocity.y > 0 && jump == 1){
                                player.body.velocity.y = -350;
                                jump = 0;
                            }
                        }
                        
                 }
                else{
                    
                }

            }

               //onTouchEnter: function (event) {}
        });

    </script>
    </div>

</body>


</html>